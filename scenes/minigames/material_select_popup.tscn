[gd_scene load_steps=6 format=3 uid="uid://bsjp8w4bw1sb2"]

[ext_resource type="Script" uid="uid://bg7o110gecbgs" path="res://scripts/crafting/weapon_material_data.gd" id="1_4ysgo"]
[ext_resource type="Resource" uid="uid://b7f1xt8sai4l1" path="res://data/weapon/materials/copper.tres" id="2_l2idu"]
[ext_resource type="Resource" uid="uid://b1qe5hffbbbqj" path="res://data/weapon/materials/gold.tres" id="3_j10xm"]
[ext_resource type="Resource" uid="uid://g5k57m8utwwn" path="res://data/weapon/materials/iron.tres" id="4_sporn"]

[sub_resource type="GDScript" id="GDScript_n82oa"]
script/source = "extends Panel

signal material_selected(material: WeaponMaterialData)

@export var material_list: Array[WeaponMaterialData]
@onready var hbox := $HBoxContainer
@export var offset_y = 50
var lock_icon_path= \"res://assets/ui/lock_icon_01.png\"
func _ready():
	visible = false
	_load_materials()

func open():
	visible = true
	_center_panel()
	_load_materials()

func close():
	visible = false

func _center_panel():
	var vp_size = get_viewport_rect().size
	var my_size = size
	position = Vector2(
		(vp_size.x - my_size.x) * 0.5,
		(vp_size.y - my_size.y) * 0.5 + offset_y
	)

func _load_materials():
	# Pre-load hình ổ khóa để dùng trong vòng lặp
	var lock_texture = load(lock_icon_path)
	
	# Xóa các icon cũ
	for c in hbox.get_children():
		c.queue_free()

	var count := material_list.size()

	for i in count:
		var mat := material_list[i]

		# --- TẠO ICON NGUYÊN LIỆU (CHA) ---
		var icon := TextureRect.new()
		icon.texture = mat.icon
		icon.custom_minimum_size = Vector2(60, 60) # Set chiều cao để icon vuông vức hơn nếu cần
		icon.expand_mode = TextureRect.EXPAND_KEEP_SIZE
		icon.stretch_mode = TextureRect.STRETCH_SCALE
		
		# --- KIỂM TRA ĐIỀU KIỆN (COIN + ORE) ---
		# 1. Lấy số lượng hiện tại
		var current_ore_amount = GameManager.materials_wallet.get(mat.id, 0)
		# Lưu ý: Mình giả sử biến lưu tiền hiện tại là GameManager.coins. 
		var current_coin_amount = GameManager.coin_count
		
		# 2. So sánh giá
		var is_enough_ore = current_ore_amount >= GameManager.material_crafting_cost
		var is_enough_coin = current_coin_amount >= GameManager.crafting_cost
		
		# Điều kiện mở khóa: Phải đủ cả Ore VÀ Coin
		var is_unlocked = is_enough_ore and is_enough_coin
		
		# --- [UPDATED] TOOLTIP BUILDER ---
		var name_str = mat.display_name if mat.display_name else mat.id.capitalize()
		var tip = \"%s\\nBase Damage: %d\\nDurability: %d\" % [name_str, mat.damage, mat.durability]

		if is_unlocked:
			# --- TRẠNG THÁI: MỞ KHÓA ---
			icon.modulate = Color(1, 1, 1, 1)
			icon.mouse_default_cursor_shape = Control.CURSOR_POINTING_HAND
			
			tip += \"\\n[COST]\"
			tip += \"\\n• %d Coin\" % GameManager.crafting_cost
			tip += \"\\n• %d %s\" % [GameManager.material_crafting_cost, name_str]
			
		else:
			# --- TRẠNG THÁI: KHÓA ---
			icon.modulate = Color(0.4, 0.4, 0.4, 1) # Làm tối icon nguyên liệu
			icon.mouse_default_cursor_shape = Control.CURSOR_FORBIDDEN
			
			# --- THÊM ICON Ổ KHÓA ---
			var lock_rect = TextureRect.new()
			lock_rect.texture = lock_texture
			lock_rect.expand_mode = TextureRect.EXPAND_IGNORE_SIZE
			# Chỉnh size ổ khóa (ví dụ 32x32 hoặc nhỏ hơn icon gốc 1 chút)
			lock_rect.custom_minimum_size = Vector2(32, 32) 
			lock_rect.size = Vector2(32, 32)
			
			# Căn giữa ổ khóa trong icon cha
			lock_rect.layout_mode = 1 # Anchors Preset Mode
			lock_rect.anchors_preset = Control.PRESET_CENTER
			
			icon.add_child(lock_rect)

			# --- THÔNG BÁO THIẾU CỤ THỂ ---
			tip += \"\\n[LOCKED]\"
			if not is_enough_coin:
				tip += \"\\n(- MISSING COIN: %d/%d)\" % [current_coin_amount, GameManager.crafting_cost]
			if not is_enough_ore:
				tip += \"\\n(- MISSING ORE: %d/%d)\" % [current_ore_amount, GameManager.material_crafting_cost]

		icon.tooltip_text = tip
		
		# --- XỬ LÝ CLICK ---
		icon.gui_input.connect(func(event):
			if event is InputEventMouseButton \\
			and event.pressed \\
			and event.button_index == MOUSE_BUTTON_LEFT:
				
				# 1. Visual check (Dùng biến is_unlocked đã tính ở trên)
				if not is_unlocked:
					_shake_icon(icon)
					print(\"UI: Item is locked!\")
					return

				# 2. Logic thanh toán (Vẫn giữ kiểm tra lại để an toàn)
				if not GameManager.pay_entry_fee():
					_shake_icon(icon)
					return
				
				if GameManager.pay_material_fee(mat.id, GameManager.material_crafting_cost):
					close()
					material_selected.emit(mat)
				else:
					GameManager.refund_all_fees()
					_shake_icon(icon)
		)

		hbox.add_child(icon)

		if i < count - 1:
			var sep := VSeparator.new()
			sep.custom_minimum_size = Vector2(8, 0)
			hbox.add_child(sep)

func _shake_icon(control: Control):
	var tween = create_tween()
	var original_modulate = control.modulate
	
	tween.tween_property(control, \"modulate\", Color(1, 0, 0, 1), 0.05)
	tween.tween_property(control, \"modulate\", original_modulate, 0.05)
	tween.tween_property(control, \"modulate\", Color(1, 0, 0, 1), 0.05)
	tween.tween_property(control, \"modulate\", original_modulate, 0.05)
"

[node name="MaterialSelectPopup" type="Panel"]
offset_right = 220.0
offset_bottom = 100.0
script = SubResource("GDScript_n82oa")
material_list = Array[ExtResource("1_4ysgo")]([ExtResource("2_l2idu"), ExtResource("3_j10xm"), ExtResource("4_sporn")])

[node name="HBoxContainer" type="HBoxContainer" parent="."]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
offset_left = -1.0
offset_right = -1.0
grow_horizontal = 2
grow_vertical = 2
size_flags_horizontal = 3
size_flags_vertical = 3
